= Cloudera K8soperators Hands-on Labs Provisioner
v0.1, 2025-06-01: Draft
:imagesdir: https://github.com/cloudera/ClouderaSetup/blob/main/images
:description: Automated Deployment instructions for Cloudera Kubernetes Operators
:toc: left
:toclevels: 2
:sectnums:
:source-highlighter: rouge
:icons: font
:imagesdir: ./images
:hide-uri-scheme:
:homepage: https://github.com/cloudera/cloudera-partners


== Overview

`Cloudera` provides a set of `Kubernetes operators` that enable users to deploy and manage `Cloudera Data In Motion (DIM)` products on `Kubernetes` clusters. These operators simplify the deployment, scaling, and management of `DIM` products, allowing users to focus on their data processing tasks rather than the underlying infrastructure.

**DimK8sProvisioner** is a solution designed to automate the deployment of `DIM k8s operators` in a `Kubernetes` cluster. It simplifies the process of setting up and configuring the necessary components, enabling users to focus on utilizing the operators rather than dealing with complex deployment tasks.

This automation includes steps to deploy `DIM` k8s operators with two `kubernetes` distributions: `Minikube` and `EKS`. 

* To provision an `EKS` cluster, you need a remote host running `Ubuntu OS` with `AWS` access already configured. 
* For the `Minikube` distribution, you can use an existing remote `Ubuntu OS` host or let the automation create a new `EC2 instance` with `Ubuntu OS` to host the `Minikube` cluster.

By executing a single command it creates a **disposable** on-demand stack consists of:

1. `EC2 Instance` with `Ubuntu OS` (If provision_ec2 is set to YES)
2. `Minikube` `Kubernetes` Custer (If `K8S_DISTRIBUTION=minikube`)
3. `EKS` `Kubernetes` Cluster (If `K8S_DISTRIBUTION=eks`)
4. `DIM k8s operators` (`CFM`, `CSA`, `CSM`)
5. `DIM` Operator Products (`NiFi`, `NiFi Registry`, `Flink`, `SSB`, `Kafka`)

== Technology Stack
**DimK8sProvisioner** employs a robust toolchain consisting of:

1. `Ansible`
2. `Terraform`
3. `AWS CLI`
4. `Shell Scripting`

All the mentioned tools integrate seamlessly and come packaged as a `Docker` container for use.

== Prerequisites
The ready to use container takes care of all the dependencies of required tools & does not require user to install or configure any of the above listed tools. 
For using this user should have:

. A Valid Cloudera License
.. Request a https://github.com/cloudera/cloudera-partners/tree/main/PartnerResources#partner-developer-license-program[Free Partner Developer License]
. *Programatic Access*(`AWS_ACCESS_KEY_ID` & `AWS_SECRET_ACCESS_KEY`) or *SSO details* of the *AWS account* with `Administrator` or `Power User` Role or *Role Assignment* to EC2 deployer machine *via sts:assumeRole* method. 
. `Docker` installed on your host from where you are running the docker automation.
. Below is the minimal configuration required when using an existing remote host for the installation of `K8s operators`
.. Ubuntu 22.04
.. 8 vCPU
.. 32 GB RAM
.. 100 GB storage


=== How to install `Docker` on your local machine

Follow mentioned link for link:https://docs.docker.com/engine/install/[**installing Docker**] on your machine.


=== AWS Account Access
To provision the infrastructure on `AWS`, you need to have access to an `AWS account` with the necessary permissions. The automation requires programmatic access to `AWS services`, which can be achieved through various methods. Below are the recommended ways to authenticate with your `AWS account`:

There are three ways you can authenticate with `AWS Account`:

.. Normal Way: *Using AWS ACCESS_KEY_ID and SECRET_ACCESS_KEY*

... Open the `IAM` console at https://console.aws.amazon.com/iam/.
... On the navigation menu, click on Users
... Click on your `IAM` user name
... Open the Security credentials tab, and then click on `Create access key`.
... To see the new access key, click on Show. Your credentials resemble the following:
+
[.shell]
----
 Access key ID: SAMPLEODNN7EXAMPLE
 Secret access key: examplesecret123/PSESECRETENG/myPSERfiCYEXAMPLEKEY

 To download the above key pair, choose Download .csv file. Store the .csv file with keys in a secure location.
----
... Configure the AWS credentials on your Laptop.
+
[.shell]
----
ksahu@Kuldeeps-MacBook-Air build % aws configure
AWS Access Key ID [****************WXYZ]: <Enter_ACCESS_KEY_ID>
AWS Secret Access Key [****************abcd]: <Enter_SECRET_ACCESS_KEY>
Default region name [None]: <Enter>
Default output format [None]: <Enter>
ksahu@Kuldeeps-MacBook-Air build % 
----

.. *Using Single Sign On (SSO)* for AWS, If your organization supports this method:
+
[.shell]
----
ksahu@Kuldeeps-MacBook-Air build % aws configure sso
SSO session name (Recommended): my-sso
SSO start URL [None]: https://cloudera.awsapps.com/start                 #Enter your org's SSO url.
SSO region [None]: us-east-1                #AWS region where your org's SSO server is deployed on AWS.

Attempting to automatically open the SSO authorization page in your default browser.

If the browser does not open or you wish to use a different device to authorize this request, open the following URL:
https://device.sso.us-east-1.amazonaws.com/

Then enter the code:
DPVH-GCXS

There are 3 AWS accounts available to you.
Using the account ID 01234567890
The only role available to you is: cldr_poweruser
Using the role name "cldr_poweruser"
CLI default client Region [None]: <Enter>
CLI default output format [None]: <Enter>
CLI profile name [cldr_poweruser-01234567890]: default

# Run below command to verify
ksahu@Kuldeeps-MacBook-Air build % aws s3 ls
----

.. *Using Role Assignment to EC2 instance* for example a Deployer Machine, from where you run the `Docker` container to deploy the HoL Infra *(via sts:assumeRole)*.
+
... Sign in to the AWS Management Console

    .... Go to the AWS Management Console: https://aws.amazon.com/console/
    .... Enter your credentials to sign in.

... Navigate to `IAM` Dashboard

    .... In the AWS Management Console, search for **IAM** in the search bar.
    .... Click on **IAM** to open the Identity and Access Management dashboard.

... Create a New Role

    .... In the left navigation pane, click on **Roles**.
    .... Click on the **Create role** button.

... Choose Trusted Entity

    .... Select **AWS service** as the trusted entity.
    .... Under **Use case for other AWS services**, choose **EC2**.
    .... Click on **Next: Permissions**.

... Attach Policies

    .... In the policy search box, type **AdministratorAccess**.
    .... Check the box next to **AdministratorAccess** to attach the policy.
    .... Click on **Next: Tags**.

... Add Tags (Optional)

    .... (Optional) You can add tags to help identify the role.
    .... Click on **Next: Review**.

... Review and Create `Role`

    .... Enter a **Role name** (for example, `CDPAWSAdminRole`).
    .... Review the details and click on **Create role**.

... Navigate to `EC2` Dashboard

    .... In the AWS Management Console, search for **EC2** in the search bar.
    .... Click on **EC2** to open the EC2 dashboard.

... Select Your `EC2 Instance`

    .... In the left navigation pane, click on **Instances**.
    .... Select the EC2 instance to which you want to assign the role.

... Attach the `IAM` Role

    .... With the instance selected, click on the **Actions** dropdown menu.
    .... Navigate to **Security** > **Modify IAM Role**.
    .... In the **IAM role** dropdown, select the role you just created (for example, `EC2AdminRole`).
    .... Click on **Update IAM role** to apply the changes.

... Verify Role Assignment

    .... With the instance still selected, check the **Description** tab at the bottom.
    .... Under **IAM role**, confirm that your role (for example, `EC2AdminRole`) is listed.
    .... You can also verify the role assignment by running the following command in your terminal.
+
[.shell]
----
aws iam list-attached-role-policies --role-name EC2AdminRole
----

---

== How To Use

image::HowToUse.png[HowToUse,600,400]

=== Get the Docker Image
The `Docker` image is available at `Docker Hub`. Once the `Docker` is installed and ready to use, pull the **k8soperator_deployment:latest ** image by executing below command.

[.shell]
----
docker pull clouderapartners/k8soperator_deployment:latest 
----

---

=== Define Configuration Values For Stack
This `Docker` based provisioner requires values of mandatory parameters to provision the infrastructure. It reads the values of these parameters from a configuration file hosted on your local machine. This section walks you through all the steps which are required to create a configuration file. This is the most **important** part so please dont skip any step of this section.

==== Create a new folder
Create a folder inside your user home directory on your local machine by name **k8soperators**. This folder will store the configuration file, `cloudera license` file and output generated in further steps.

**Mac/Linux Users:**

[.shell]
----
mkdir -p ~/k8soperators
----

**Windows Users:**

[.shell]
----
md C:\Users\<username>\k8soperators
----

. Download the  **configuration/configfile** and place it inside the above created directory. Make sure you don't add any file extension to it. (.txt,.doc).

. Similarly, download the **cloudera license** file and place it inside the same directory.

==== Edit the Configuration File

Navigate to `k8soperators` directory and edit the `configfile` with the help of an editor of your choice. **Don't add any quotes(single or double) in values and no 'new line' after the last entry in the file.** Refer to below table for defining values of the parameters.

[%header,cols="1,1,1"]
|===
|Parameter
|Description
|Remarks

|PROVISION_EC2
|Provision EC2 Instance or Skip
|No quotes 

**YES** If EC2 provisioning is required.

**NO** If EC2 provisioning is not required.

|K8S_DISTRIBUTION
|Kubernetes Distribution to be used for provisioning
|No quotes, only lowercase

Values can be either 'minikube' or 'eks'

|ADMIN_PASSWORD
|Admin User Password for `NiFi/NiFi Registry` ui and `openldap` secrets
|No quotes

|CLOUDERA_USERNAME
|Cloudera admin user received during license registration to authenticate with cloudera repos
|No quotes

|CLOUDERA_PASSWORD
|Cloudera admin passwords received during license registration to authenticate with cloudera repos
|No quotes

|AWS_REGION
|Region in which resources will be deployed
|No quotes, only lowercase with numbers

|LOCAL_MACHINE_IP
|Public IPV4 address of local machine from which you are running the Docker container.
|No quotes and don't remove /32

|INSTALL_OPERATORS
|A comma separated list of k8s operators to install.
|`**CFM**` If only one of them is required.

`**CFM,CSA**` If any two of them are required.

`**CFM,CSA,CSM**` or `**ALL**`  If all three are required.

Only from the provided values
|===


==== Parameters with Conditional Requirement

[NOTE]
====
If the `**INSTALLATION_HOST**` value is not defined in `configfile`, automation will create a new `ec2_instance`. When `K8S_DISTRIBUTION=EKS`, the `**INSTALLATION_HOST**` is a **mandatory** parameter and the host should have `Ubuntu OS` installed and access to create an `EKS` cluster and other resources in the `AWS account`. 
====

[%header,cols="1,1,1"]
|===
|Parameter
|Description
|Remarks

|INSTALLATION_HOST
|The remote host where the `K8s operators` will be installed. It can be either the public IP address of an `EC2 instance` or a remote machine with `Ubuntu OS`.

Keep it commented if you want to provision EC2 instance as well(Default).
|No quotes, only IPv4 address. **MANDATORY** if `K8S_DISTRIBUTION=EKS`.

|SSH_KEY_PAIR
|If you want to utilize an already existing keypair, uncomment the corresponding entry in `configfile` and override the value with the keypair name.
|Only base name without `.pem `extension. 

**MANDATORY** if installing on an existing remote host with `Ubuntu OS` or if `K8S_DISTRIBUTION=EKS`.
|=== 


[NOTE]
====
If the `**SSH_KEY_PAIR**` value is not defined and `**PROVISION_EC2=YES**` in `configfile`, automation will generate a new keypair and place pem file inside **userconfig** directory.
In case you have defined `**SSH_KEY_PAIR**` in `configfile` in earlier step, Place the same `**SSH_KEY_PAIR.pem**` file under **userconfig** directory.
====

==== Optional Parameters

[NOTE]
====
**Below are the optional parameters that should only be changed if any customization is needed. If you intend to proceed with the default configuration values, do not modify and/or uncomment the values. If you need to make changes, please refer to the table below for detailed instructions on providing the correct values. To override the default values for optional parameters for any of paremeters, uncomment the parameter Key and provide/update the values corresponding to them when required.**
====

[%header,cols="1,1,1"]
|===
|Parameter
|Description
|Remarks

|INSTANCE_TYPE
|Possible values: **m5.2xlarge, m4.2xlarge** etc.
|Default value is **m5.2xlarge**. If you want to override, uncomment the corresponding entry in `configfile` and replace the override value with one of the supported AWS instance types. Regarding supported instance types, kindly refer AWS official documentation. 

|CLUSTER_NAME:
|This parameter will be used to name the `EKS` cluster as well as the `EC2 instance`. If you want to override the default value, uncomment the corresponding entry in `configfile` and replace the override value with your desired cluster name.
|No quotes
|===

=== Provision Stack
Once the `configfile` is created as outlined in **Step 4.2** . The provisioning of infrastructure in interactive mode can be started by executing below command.

**For Mac/Linux/Windows Users:**

[.shell]
----
docker run -it \
  -v ~/k8soperators:/k8soperators \
  -v ~/.aws:/root/.aws \
  k8soperator_deployment:latest provision
----

[NOTE]
The above commands will start the `Docker` container in interactive mode and will display the process output and messages on the terminal. Make sure you don't close the terminal or your machine does not go to into sleep mode because of inactivity. 
If you wan to run the container in background/detach mode then replace the '-it' flag in above commands with '-d'(without quotes). You can check the logs of container by below commands.

To get the container ID or Name:
[.shell]
----
docker ps
----

To get the logs:
[.shell]
----
docker logs -f <CONTINER_ID> OR <CONTAINER_NAME>
----

=== Destroy Stack
After succesful demo of the DIM operators, the complete stack can be destroyed using one single command as below. The **destroy** operation will take care of deleting/removing all of the below resources: 


1. Delete the `k8s operators` and their products
2. Delete the underlying k8s cluster (EKS or Minikube)
3. Delete the `EC2 instance` (If provisioned)


**For Mac/Linux/Windows Users:**
 
[.shell]
----
docker run -it \
  -v ~/k8soperators:/k8soperators \
  -v ~/.aws:/root/.aws \
  k8soperator_deployment:latest destroy
----

[NOTE]
The above commands will start the `Docker` container in interactive mode and will display the process output
and messages on the terminal. Make sure you don't close the terminal or
your machine does not go to into sleep mode because of inactivity. 
If you wan to run the container in background/detach mode then replace the '-it' flag in above commands
with '-d'(without quotes). You can check the logs of container by below commands

To get the container ID or Name:
[.shell]
----
docker ps

----
To get the logs:
[.shell]
----
docker logs -f <CONTINER_ID> OR <CONTAINER_NAME>

----